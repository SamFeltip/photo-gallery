---
import fs from "fs";
import path from "path";
import BaseLayout from "~/layouts/BaseLayout.astro";

const imagesDirPath = import.meta.env.PROD
  ? import.meta.env.IMAGES_DIR_PROD
  : import.meta.env.IMAGES_DIR_DEV;

const imagesDir = new URL(imagesDirPath, import.meta.url).pathname;

// Get all gallery folders
const galleryFolders = fs
  .readdirSync(imagesDir, { withFileTypes: true })
  .filter((dirent) => dirent.isDirectory())
  .map((dirent) => dirent.name);

// For each gallery, get the first image file
const galleries = galleryFolders.map((folder) => {
  const folderPath = path.join(imagesDir, folder);
  const images = fs
    .readdirSync(folderPath)
    .filter((file) => /\.(jpg|jpeg|png|gif|webp)$/i.test(file));
  return {
    name: folder,
    preview: images.length > 0 ? `/preview/${folder}/card.jpeg` : null,
    link: `/${folder}`,
  };
});
---

<BaseLayout title="Home" description="Welcome to my photo gallery.">
  <ul id="galleries">
    {
      galleries.map((gallery) => (
        <li class="gallery">
          {gallery.preview && (
            <a href={gallery.link}>
              <img src={gallery.preview} alt={gallery.name + " preview"} />
              <h2 style="margin: 0; font-size: 1.5rem;">{gallery.name}</h2>
            </a>
          )}
        </li>
      ))
    }
  </ul>
</BaseLayout>

<style>
  ul#galleries {
    display: flex;
    flex-direction: column;
    align-items: center;
    list-style: none;
    padding: 0;
    margin-top: 2rem;
  }

  /* @media screen and (min-width: 600px) {
    ul#galleries {
      margin-top: 5rem;
    }
  }

  @media screen and (max-width: 600px) {
    ul#galleries {
      margin-top: 2rem;
    }
  } */

  li.gallery {
    display: grid;
    grid-template-columns: 1fr;

    align-items: center;
    margin: 0 1rem 1.5rem 1rem;

    & a {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-decoration: none;
      color: inherit;
      text-transform: capitalize;
    }

    & img {
      /* max-height: 100px; */
      object-fit: cover;
      border-radius: 8px;
      aspect-ratio: 4 / 3;
    }
  }

  @media screen and (min-width: 500px) {
    li.gallery {
      grid-template-columns: 300px 1fr;
      & a {
        flex-direction: row;
      }
      & img {
        max-height: 150px;
        margin-right: 2rem;
      }
    }
  }

  li.gallery:hover {
    transform: scale(1.1);
    transition: transform 0.2s;
  }
</style>
